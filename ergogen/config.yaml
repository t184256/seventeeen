meta:
  engine: 4.1.0

units:
  u: 17
  hu: u/2
  default_spread: 17
  # MCU positioning, a lot of stuff is tied to that
  mcu_dx: -20  # should leave 1mm MCU <-> keycap
  mcu_dy: 1.5

points:
  zones:
    matrix:
      # anchor:
      #    shift: [50,-75] # Fix KiCad placement ???
      columns:
        outer:
          key:
            stagger: 0
          rows:
            bottom:
              row_net: P3
              column_net: P0
              skip: true
            home:
              row_net: P4
              column_net: P0
            top:
              row_net: P5
              column_net: P0
            num:
              row_net: P6
              column_net: P0
              skip: true
        pinky:
          key:
            stagger: 0
          rows:
            bottom:
              row_net: P3
              column_net: P1
            home:
              row_net: P4
              column_net: P1
            top:
              row_net: P5
              column_net: P1
            num:
              row_net: P6
              column_net: P1
        ring:
          key:
            origin: [-12, -19]
            stagger: 9
          rows:
            bottom:
              row_net: P3
              column_net: P2
            home:
              row_net: P4
              column_net: P2
            top:
              row_net: P5
              column_net: P2
            num:
              row_net: P6
              column_net: P2
        middle:
          key:
            stagger: 2
          rows:
            bottom:
              row_net: P3
              column_net: P10
            home:
              row_net: P4
              column_net: P10
            top:
              row_net: P5
              column_net: P10
            num:
              row_net: P6
              column_net: P10
        index:
          key:
            stagger: -9
          rows:
            bottom:
              row_net: P3
              column_net: P9
            home:
              row_net: P4
              column_net: P9
            top:
              row_net: P5
              column_net: P9
            num:
              row_net: P6
              column_net: P9
        inner:
          key:
            stagger: 0
          rows:
            bottom:
              column_net: P8
              row_net: P3
            home:
              column_net: P8
              row_net: P4
            top:
              row_net: P5
              column_net: P8
            num:
              row_net: P6
              column_net: P8
      rows:
        bottom:
          padding: u
        home:
          padding: u
        top:
          padding: u
        num:
          padding: u
    thumb:
      anchor:
        ref: matrix_inner_bottom
        shift: [0, -17 - 8]
      columns:
        home:
          key:
            spread: 17
            origin: [0,0]
          rows:
            home:
              row_net: P6
              column_net: P7

outlines:
  keycaps_17:
    - what: rectangle
      where: true
      asym: source
      size: 17
      corner: 0
  keycaps_rounded:
    - what: rectangle
      where: true
      asym: source
      size: 16.75
      corner: 2
  switches_15:
    - what: rectangle
      where: true
      asym: source
      size: 15
  switches_14:
    - what: rectangle
      where: true
      asym: source
      size: 14
  switches_rounded:
    - what: rectangle
      where: true
      asym: source
      size: 15
      corner: 0.6
  underside_approx:
    # general keys: wide mounting for the hotswap switch contacts
    - what: rectangle
      where: /matrix_(pinky|ring|middle|index).*/
      asym: source
      size: [19.25, 5]
      adjust.shift: [0, 4]
    # general keys: narrow for the top of the switch
    - what: rectangle
      where: /matrix_(pinky|ring|middle|index).*/
      asym: source
      size: [6, 4]
      adjust.shift: [0, 6.5]
    # general keys: holes
    - what: circle
      where: /matrix_(outer|pinky|ring|middle|index).*/
      radius: 1.75
      asym: source
      adjust.shift: [0, 0]
    - what: circle
      where: /matrix_(outer|pinky|ring|middle|index).*/
      radius: 1.1
      asym: source
      adjust.shift: [5.5, 0]
    - what: circle
      where: /matrix_(outer|pinky|ring|middle|index).*/
      radius: 1.1
      asym: source
      adjust.shift: [-5.5, 0]
    # general keys: diodes
    - what: rectangle
      where: /matrix_(outer|pinky|ring|middle|index).*/
      asym: source
      size: [6, 4]
      adjust.shift: [0, -4.75]
    # inner keys: wide mounting for the hotswap switch contacts
    - what: rectangle
      where: /matrix_inner.*/
      asym: source
      size: [19.25, 5]
      adjust.shift: [0, 4]
      adjust.orient: 90
    # inner keys: general overkill
    - what: rectangle
      where: /matrix_inner.*/
      asym: source
      size: [15, 16]
      adjust.shift: [0, .5]
      adjust.orient: 90
  _square:
    - what: polygon  # all borders
      operation: stack
      points:
        - ref: thumb_home_home
          shift: [hu,-hu]
        - ref: thumb_home_home
          shift: [-102+hu,-hu]
        - ref: thumb_home_home
          shift: [-102+hu,102-hu]
        - ref: thumb_home_home
          shift: [hu,102-hu]
  _custom_outline:
    - what: polygon  # all borders
      operation: stack
      points:
        - {ref: thumb_home_home, shift: [ hu, -hu]}  # bottom right of the PCB
        - {ref: thumb_home_home, shift: [-32, -hu]}  # bottom left o'MCU
        - {ref: thumb_home_home, shift: [-32,10.5]}  # top left o'MCU
        - {ref: thumb_home_home, shift: [-54,10.5]}  # control point
        - {ref: matrix_pinky_bottom, shift: [+hu, -hu - 4]}  # control point
        - {ref: matrix_pinky_bottom, shift: [+hu, -hu]}  # pinky bottom right
        - {ref: matrix_pinky_bottom, shift: [-hu, -hu]}  # pinky bottom left
        - {ref: matrix_outer_home, shift: [+hu, -hu]}  # outer bottom right
        - {ref: matrix_outer_home, shift: [-hu, -hu]}  # outer bottom left
        - {ref: matrix_outer_top, shift: [-hu, +hu]}  # outer top left
        - {ref: matrix_outer_top, shift: [+hu, +hu]}  # outer top right
        - {ref: matrix_pinky_num, shift: [-hu, +hu]}  # pinky top left
        - {ref: matrix_pinky_num, shift: [+hu, +hu]}  # pinky top right
        - {ref: matrix_ring_num, shift: [-hu, +hu]}  # ring top left
        - {ref: matrix_ring_num, shift: [+hu, +hu]}  # ring top right
        - {ref: matrix_middle_num, shift: [-hu, +hu]}  # middle top left
        - {ref: matrix_middle_num, shift: [+hu, +hu]}  # middle top right
        - {ref: matrix_middle_num, shift: [-hu, +hu]}  # middle top left
        - {ref: matrix_middle_num, shift: [+hu, +hu]}  # middle top right
        - {ref: matrix_index_num, shift: [-hu, +hu]}  # index top left
        - {ref: matrix_index_num, shift: [+hu, +hu]}  # index top right
        - {ref: matrix_inner_num, shift: [-hu, +hu]}  # inner top left
        - {ref: matrix_inner_num, shift: [+hu, +hu]}  # inner top right
  mounting:
    - what: circle  # ne
      radius: 3.2 / 2
      where:
        ref: thumb_home_home
        shift: [10 - 2.5, 93 - 2.5]
    - what: circle  # sw
      radius: 3.2 / 2
      where:
        ref: matrix_outer_home
        shift: [0, -hu - 5]
    - what: circle  # nw
      radius: 3.2 / 2
      where:
        ref: matrix_outer_top
        shift: [0, +hu + 5]
    - what: circle  # se
      radius: 3.2 / 2
      where:
        ref: thumb_home_home
        shift: [10 - 2.5, -9 + 2.5]
    - what: circle  # extra
      radius: 3.2 / 2
      where:
        ref: matrix_ring_num
        shift: [-13.25, 8]
  pcb_perimeter:
    - what: outline
      name: _custom_outline
    - what: outline  # keys, should change nothing
      name: keycaps_17
      operation: add
    # uncomment to square the board
    #- what: outline
    #  name: _square
    #  operation: add
  silhouette:
    - what: outline
      name: pcb_perimeter
    - what: outline  # keys
      name: mounting
      operation: subtract

pcbs:
  seventeeen:
    template: kicad8
    outlines:
      main:
        outline: pcb_perimeter
    footprints:
      keys_normal:
        what: ceoloide/switch_choc_v1_v2
        where: true
        params:
          from: "{{column_net}}"
          to: "{{colrow}}"
          include_keycap: true
          keycap_width: 17
          keycap_height: 17
          reversible: true
          hotswap: false
          solder: true # let's have fun
          include_plated_holes: true
          center_hole_diameter: 3.25  # 3.2 + .05
          # files are patched for 0.06" ~= 1.52 mm solder holes to fit Mill-Max
          choc_v2_support: false
          choc_v1_stabilizers_diameter: 1.8  # 1.9 - .1
          include_choc_v1_led_cutout_marks: true
          include_corner_marks: true
        adjust.rotate: 180
      diode_normal:
        what: ceoloide/diode_tht_sod123
        where: true
        params:
          from: "{{colrow}}"
          to: "{{row_net}}"
          reversible: true
          include_traces_vias: true
          trace_distance: -1.1
        adjust.shift: [0, 4.7]  # see footprint
        adjust.rotate: 180
      seeed:
        what: ceoloide/seeed_xiao
        where: thumb_home_home
        params:
          reversable: true
          label: false
          instructions: false
        adjust.shift: [mcu_dx, mcu_dy]
        adjust.rotate: 90
      battery_underpad_l:
        what: pad
        where: thumb_home_home
        params:
          width: 1.5
          height: 1.5
          net: BAT_PS  # switched
        adjust.shift: [mcu_dx - 0.25, mcu_dy + 3.5]
      battery_underhole_l:
        what: ceoloide/mounting_hole_plated
        where: thumb_home_home
        params:
          drill: 0.8
          outline: 0.5
          net: BAT_PS  # switched
        adjust.shift: [mcu_dx - 0.25, mcu_dy + 4.5]
      battery_underpad_r:
        $extends: pcbs.seventeeen.footprints.battery_underpad_l
        adjust.shift: [mcu_dx - 0.25, mcu_dy - 3.5]
      battery_underhole_r:
        $extends: pcbs.seventeeen.footprints.battery_underhole_l
        adjust.shift: [mcu_dx - 0.25, mcu_dy - 4.5]
      battery_underroute:
        what: ceoloide/utility_router
        params.width: 0.25
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.route: 'f(-0.25,-4.5)(-0.25,4.5)'
        params.net: BAT_PS

      battery_connector_1:
        what: ceoloide/battery_connector_jst_ph_2
        where: matrix_inner_bottom
        adjust.shift: [5.65, -12.5]  # same clearance to right as key plateds
        adjust.rotate: 270
        params.side: B  # not really, I just wanna swap polarity
        params.BAT_P: BAT_P
        params.BAT_N: GND
        # no need to make reversible if I can flip battery wires in connector
      bat_hole_p_e:
        what: ceoloide/mounting_hole_npth
        where: matrix_inner_bottom
        adjust.shift: [5.65 - 15, -12.5 + 1.75]
        params:
          hole_size: 2.75  # should enough for a single crimped battery cable
          hole_drill: 2.75
      bat_hole_g_e:
        $extends: pcbs.seventeeen.footprints.bat_hole_p_e
        adjust.shift: [5.65 - 15, -12.5 - 1.75]
      bat_hole_p_w:
        $extends: pcbs.seventeeen.footprints.bat_hole_p_e
        adjust.shift: [5.65 - 29, -11]
        params:
          hole_size: 4  # crimped battery cable + one is in the hole
          hole_drill: 4
      battery_connector_2:
        $extends: pcbs.seventeeen.footprints.battery_connector_1
        where: matrix_index_bottom
        adjust.shift: [4, -11]
      power_switch:
        what: ceoloide/power_switch_smd_side
        where: matrix_ring_bottom
        adjust.shift: [0, -19.5]
        adjust.rotate: 270
        params:
          reversible: true
          side: B  # 1.4 mm, reverse if not using hotswap?
          from: BAT_PS
          to: BAT_P

      under_mcu_hole_sw:
        what: ceoloide/mounting_hole_npth
        where: thumb_home_home
        adjust.shift: [mcu_dx - 10.25, mcu_dy - 8]
      under_mcu_hole_se:
        $extends: pcbs.seventeeen.footprints.under_mcu_hole_sw
        adjust.shift: [mcu_dx + 10.75, mcu_dy - 8]

      mounting_hole_se:
        what: ceoloide/mounting_hole_npth
        where: matrix_outer_top
        adjust.shift: [hu, -hu]
      mounting_hole_sw:
        what: ceoloide/mounting_hole_npth
        where: /matrix_(inner_num|inner_home)/
        adjust.shift: [-hu, -hu]
      stabilization_hole_sw:
        what: ceoloide/mounting_hole_npth
        params:
          hole_size: 1.1
          hole_drill: 1.1
        where: /matrix_(ring_num|index_home)/
        adjust.shift: [-hu, -hu]
      stabilization_hole_se:
        $extends: pcbs.seventeeen.footprints.stabilization_hole_sw
        where: /matrix_(pinky_home|middle_num)/
        adjust.shift: [hu, -hu]
      mounting_hole_power_switch:
        what: ceoloide/mounting_hole_npth
        where: matrix_ring_bottom
        adjust.shift: [-6.75, -hu - 11]

      #battery_area:
      #  what: ceoloide/utility_filled_zone
      #  where: matrix_middle_bottom
      #  adjust.shift: [0, -10]
      #  params:
      #    name: battery
      #    points: [[0,0],[30,0],[30,12],[0,12]]

      name_version:
        what: ceoloide/utility_text
        where: matrix_middle_bottom
        params:
          text: 'seventeeen v0.4'
          reversible: true
          width: 1.4
          height: 1.4
        adjust:
          shift: [0,-hu-1]

      # MCU-tied routing: columns
      P7_route:  # thumb column
        what: ceoloide/utility_router
        params.width: 0.2
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.route: b(7.5,-7.5)(9,-6)(9,4.5)(10.5,6)(12.5,6)(14,7.5)(20,7.5)
        params.net: P7
      P6_route:  # num + thumb row
        what: ceoloide/utility_router
        params.width: 0.2
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.routes:
          - f(7.5,7.5)(7.5,-3)(9,-4.5)(20.75,-4.5)(22,-3.5)  # 1.5, diode
          - f(22,-3.5)(23,-4.5)(25.5,-4.5)(27.5,-6.5)(27.5,-77.25)  # 2
          - f(27.5,-77.25)(25.5,-79.25)(22,-79.25)  # 2
        params.net: P6
      P5_route:  # top row
        what: ceoloide/utility_router
        params.width: 0.2
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.routes:
          - f(5,7.5)(5,-3)(7,-5)(25.5,-5)(27,-6.5)(27,-60.75)  # 2 and 1.5
          - f(27,-60.75)(25.5,-62.25)(22,-62.25)  # 1.5
        params.net: P5
      P4_route:  # home row
        what: ceoloide/utility_router
        params.width: 0.2
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.routes:
          - f(2.5,7.5)(2.5,-3)(5,-5.5)(22,-5.5)  # bend: 2.5
          - f(22,-5.5)(23,-6.5)(23,-42.5)(22,-43.5)(22,-45.5)  # bend: 1
        params.net: P4
      P3_route:  # bottom row
        what: ceoloide/utility_router
        params.width: 0.2
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.routes:
          - f(0,7.5)(0,6.5)(1.5,5)(1.5,-3)(4.5,-6)(22,-6)(22.5,-6.5)
          - f(22.5,-6.5)(22.5,-26)(22,-26.5)(22,-28.5)
        params.net: P3

      # MCU-tied routing: P0-P2
      P0_route:
        what: ceoloide/utility_router
        params.width: 0.2
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.net: P0
        params.routes:
          - b(-7.5,3.5)(-7.5,1.5)(-8.5,0.5)(-9.25,0.5)(-10.35,-0.6)
          - b(-10.35,-0.6)(-10.35,-10.75)(-11.25,-11.95)(-11.25,-14.5)
          - b(-11.25,-14.5)(-11.75,-15)(-28,-15)
      P1_route:
        what: ceoloide/utility_router
        params.width: 0.2
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.net: P1
        params.routes:
          - b(-5,3.25)(-5,0.75)(-6,-0.25)(-9,-0.25)(-9.15,-0.4)
          - b(-9.15,-0.4)v(-10.1,-1.35)(-10.1,-11.5)(-10.5,-12)v(-10.5,-14.5)
          - b(-10.5,-14.5)(-11.5,-15.5)(-28,-15.5)
      P2_route:
        what: ceoloide/utility_router
        params.width: 0.2
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.net: P2
        params.routes:
          - b(-2.5,3.25)(-2.5,0)(-3.5,-1)(-8.75,-1)(-9.85,-2.1)
          - b(-9.85,-2.1)(-9.85,-14.6)(-11.25,-16)(-28,-16)

      # MCU-tied routing: power
      BAT_PS_route:
        what: ceoloide/utility_router
        params.width: 0.25
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.routes:
          - b(-0.25,-2.75)(-1.5,-1.75)(-8.5,-1.75)(-9.15,-2.4)v(-9.25,-2.5)
          - f(-9.25,-2.5)(-9.25,-10.25)(-9.25,-12)(-10.25,-13)(-28.5,-13)
          - f(-28.5,-13)(-28.5,-11.75)v(-28.5,-13)
        params.net: BAT_PS
      GND_route:
        what: ceoloide/utility_router
        params.width: 0.25
        where: thumb_home_home
        adjust.shift: [mcu_dx, mcu_dy]
        params.routes:
          - b(-5,-3.5)(-6,-2.5)(-8.25,-2.5)(-9,-3.25)(-9,-9)(-8,-10)
          - b(-8,-10)(-2,-10)(-0.5,-11.5)(8.25,-11.5)(8.75,-11)(24,-11)(25,-10)
        params.net: GND

      # switch-tied power routing
      BAT_P_1_route:
        what: ceoloide/utility_router
        params.width: 0.25
        where: matrix_ring_bottom
        adjust.shift: [0, -19.5]  # power switch
        params.routes:
          - b(-0.75,-1.5)(0,-1.5)v(0.75,-1.5)(0.75,-2.75)(2,-4)(36.5,-4)
          - f(36.5,-4)(38,-2.5)(39.5,-4)(52.5,-4)v(55,-4)v
          - f(55,-4)(55.75,-4)(56.75,-3)(56.75,-1.25)

      # key-tied routing
      key_diode_route:
        what: ceoloide/utility_router
        #where: /.*(outer|pinky|ring|middle|index|inner).*/
        where: true
        params.width: 0.2
        params.net: "{{colrow}}"
        params.routes:
          - b(-2,-4.5)(-2.75,-4.5)(-3.25,-4)(-3.25,2.75)(-4.25,3.75)  # left
          - b(-2,-4.5)(-1.25,-4.5)(0,-3.25)(2.75,-3.25)(3.25,-2.75)  # right#1
          - b(3.25,-2.75)(3.25,2.75)(4.25,3.75)  # right#2
          - b(-4.5,3.75)(4.5,3.75)  # horizontal bridge
      key_column_non_top_route:
        what: ceoloide/utility_router
        where: /matrix_(.*_(home|bottom)|(pinky|ring|middle|index|inner)_top)/
        params.width: 0.2
        params.net: "{{column_net}}"
        params.routes:
          - b(0,6)(6,6)(7,5)(7,-7)(5.5,-8.5)(2.5,-8.5)(0,-11)
          - b(0,6)(-6,6)(-7,5)(-7,-7)(-5.5,-8.5)(-2.5,-8.5)(0,-11)
      key_row_route_most_normal:
        what: ceoloide/utility_router
        where: /matrix_(outer|index)_.*/
        params.width: 0.2
        params.net: "{{row_net}}"
        params.route: f(2,-4.5)(2,-5.5)(2.5,-6)(18.5,-6)(19,-5.5)(19,-4.5)
      key_row_route_pinky_to_ring:
        what: ceoloide/utility_router
        where: /matrix_pinky_.*/
        params.width: 0.2
        params.net: "{{row_net}}"
        params.routes:
          - f(2,-4.5)(2,-5.5)(2.5,-6)(7.75,-6)(9.25,-7.5)(13,-7.5)
          - f(13,-7.5)(14,-8.5)(14,-11)(15,-12)(18,-12)(19,-13)(19,-14)
      key_row_route_ring_to_middle:
        what: ceoloide/utility_router
        where: /matrix_ring_.*/
        params.width: 0.2
        params.net: "{{row_net}}"
        params.route: f(2,-4.75)(18,-4.75)(19,-5.75)(19,-6.5)
      key_row_route_middle_to_index:
        what: ceoloide/utility_router
        where: /matrix_middle_.*/
        params.width: 0.2
        params.net: "{{row_net}}"
        params.routes:
          - f(2,-4.5)(2,-5.5)(2.5,-6)(6.25,-6)(7.25,-5)(7.25,5.5)
          - f(7.25,5.5)(8.25,6.5)(18,6.5)(19,5.5)(19,4.5)
      key_column_outer_route:
        what: ceoloide/utility_router
        where: matrix_outer_home
        params.width: 0.2
        params.net: P0
        params.route: b(0,6)(1,7)(8,7)(9,8)
      key_column_pinky_route:
        what: ceoloide/utility_router
        where: matrix_pinky_bottom
        params.width: 0.2
        params.net: P1
        params.route: b(0,6)(1,7)(7.5,7)(8.5,6)(20,6)
      key_column_outer_through_pinky_route:
        what: ceoloide/utility_router
        where: matrix_pinky_bottom
        params.width: 0.2
        params.net: P0
        params.route: b(-8.5,-9.5)(-7.5,-8.5)(-7.5,6)(-6,7.5)(7.5,7.5)(8.5,6.5)(20,6.5)
      key_column_ring_route:
        what: ceoloide/utility_router
        where: matrix_ring_bottom
        params.width: 0.2
        params.net: P2
        params.routes:
          - b(0,6)(-1,7)(-8.5,7)(-9.5,8)(-9.5,13.5)(-8.5,14.5)
          - b(-8.5,14.5)(3,14.5)
      key_column_middle_route:
        what: ceoloide/utility_router
        where: matrix_middle_bottom
        params.width: 0.2
        params.net: P10
        params.routes:
          - b(0,6)(1,7)(7.5,7)(8.5,8)(8.5,14)(11,16.5)
          - b(11,16.5)(13,16.5)(14,17.5)(14,20)v(14,23)
      key_column_index_route:
        what: ceoloide/utility_router
        where: matrix_index_bottom
        params.width: 0.2
        params.net: P9
        params.route: b(0,6)(0,7.25)(-0.25,7.5)(-0.25,11)v(-0.25,16)
      key_column_inner_route:
        what: ceoloide/utility_router
        where: matrix_inner_bottom
        params.width: 0.2
        params.net: P8
        params.route:
          b(0,6)(0,7.25)(-0.25,7.5)(-14,7.5)(-15,8.5)(-15,11)v(-15,16)
